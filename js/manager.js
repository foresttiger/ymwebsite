function timestampToTime(e){var t=new Date(1e3*e);return t.getFullYear()+"-"+a(t.getMonth()+1,2)+"-"+a(t.getDate(),2)+" "+a(t.getHours(),2)+":"+a(t.getMinutes(),2)+":"+a(t.getSeconds(),2);function a(e,t){for(var a=""+e,n=a.length,i="",o=t;o-- >n;)i+="0";return i+a}}function timeToTimestamp(e){var t=new Date(e);t.getTime(),t.valueOf();return.001*Date.parse(t)}function isDate(e){var t=e.match(/^(\d+)-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);if(null==t)return!1;t[2]=t[2]-1;var a=new Date(t[1],t[2],t[3],t[4],t[5],t[6]);return a.getFullYear()==t[1]&&(a.getMonth()==t[2]&&(a.getDate()==t[3]&&(a.getHours()==t[4]&&(a.getMinutes()==t[5]&&a.getSeconds()==t[6]))))}var startTime=0,endTime=0;function refreshData(e){var t=e;"inbound"==t&&(t="pc"),loadDataToType(t)}function loadDataToType(e,t,a){var n=0;$("#selectData").empty();var i=getSession("token"),o=(getSession("scope"),'<option value="company">公司名</option><option value="proName">项目名称</option><option value="componentName">构件名称</option>'),l="http://www.zjgymzg.com/searchComponents",d={token:i,status:a};switch(console.log(e),e){case"add":case"pc":case"update":case"inbound":d.status=void 0;break;case"inboundCars":d.status=void 0,t||(d.inboundCars="");break;case"outboundCars":case"outbound":t||(d.inboundCars=""),d.status="outbound";break;case"admin":delete d.status,d.type="admin";break;case"operator":delete d.status,d.type=e;break;default:d.type=e}switch($(".select").hide(),e){case"pc":case"add":case"update":case"inbound":$(".select.inboundSearch").css("display","flex"),$(".addNewProduct").show(),$(".addAccount").hide(),$("#selectData").append(o),$(".tab-header .components").show(),$(".tab-header .outbound").hide();break;case"outbound":$(".select.inboundSearch").css("display","flex"),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append(o),$(".tab-header .components").hide(),$(".tab-header .outbound").show();break;case"inboundCars":$(".select.inboundCarsSearch").css("display","flex"),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append('<option value="inboundCars">入库车辆</option>'),$(".tab-header .components").hide(),$(".tab-header .outbound").hide();break;case"outboundCars":$(".select.outboundCarsSearch").css("display","flex"),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append('<option value="outboundCars">出库车辆</option>'),$(".tab-header .components").hide(),$(".tab-header .outbound").hide();break;case"admin":case"operator":$(".addAccount").show(),$(".addNewProduct").hide(),$(".tab-header .components").hide(),$(".tab-header .outbound").hide();break;case"adminlog":case"inboundlog":case"outboundlog":case"accountlog":-1!=["inboundlog","outboundlog","adminlog"].indexOf(e)&&$(".select.logSearch").css("display","flex"),$(".addNewProduct").hide(),$(".addAccount").hide(),$(".tab-header .components").hide(),$(".tab-header .outbound").hide()}switch(layui.use("form",function(){layui.form.render(),layer=layui.layer,n=layer.load(0,{shade:.3})}),e){case"add":case"update":case"outbound":case"inboundCars":case"outboundCars":l="http://www.zjgymzg.com/searchComponents";break;case"admin":case"operator":l="http://www.zjgymzg.com/getCustomers";break;case"adminlog":case"inboundlog":case"outboundlog":case"accountlog":l="http://www.zjgymzg.com/searchLog"}if(t)for(x in t)d[x]=t[x];$.ajax({url:l,type:"post",contentType:"application/json",data:JSON.stringify(d)}).done(function(t){layer.close(n),renderOrderTable(t.list,e)}).fail(function(e){layer.close(n),console.log(e),layer.msg("网络异常，请稍后再试！")})}function renderOrderTable(e,t){var a=[{title:"checkbox",type:"checkbox",width:80,fixed:"left"},{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"产品ID",width:80,sort:!0,align:"center",templet:"#idTpl"},{field:"company",title:"公司名",align:"center",event:"company",templet:"#companyTpl"},{field:"proName",title:"项目名称",align:"center",event:"proName",templet:"#proNameTpl"},{field:"buildingNum",title:"楼号",align:"center",event:"buildingNum",templet:"#buildingNumTpl"},{field:"floorNum",title:"层号",align:"center",event:"floorNum",templet:"#floorNumTpl"},{field:"category",title:"构件类别",align:"center",event:"category",templet:"#categoryTpl"},{field:"componentName",title:"构件名称",align:"center",event:"componentName",sort:!0,templet:"#componentNameTpl"},{field:"size",title:"尺寸",align:"center",event:"size",templet:"#sizeTpl"},{field:"volume",title:"混凝土方量",align:"center",sort:!0,event:"volume",templet:"#volumeTpl"},{field:"weight",title:"构件重量",align:"center",event:"weight",templet:"#weightTpl"},{field:"level",title:"混凝土等级",align:"center",event:"level",templet:"#levelTpl"},{field:"productDate",title:"生产日期",align:"center",event:"productDate",templet:"productDateTpl"},{field:"inboundDate",title:"入库日期",width:160,align:"center",templet:"#inboundDateTpl"},{field:"outboundDate",title:"出库日期",width:160,align:"center",templet:"#outboundDateTpl"},{field:"location",title:"区域",align:"center",templet:"#locationTpl"},{field:"inboundCars",title:"入库车辆",align:"center",templet:"#inboundCarsTpl"},{field:"outboundCars",title:"出库车辆",align:"center",templet:"#outboundCarsTpl"},{field:"right",title:"操作",width:150,toolbar:"#components",align:"center",fixed:"right"}];switch(t){case"outbound":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"产品ID",width:80,align:"center"},{field:"company",title:"公司名称",align:"center"},{field:"proName",title:"项目名称",align:"center"},{field:"buildingNum",title:"楼号",align:"center"},{field:"floorNum",title:"层号",align:"center"},{field:"category",title:"构件类别",align:"center"},{field:"componentName",title:"构件名称",align:"center"},{field:"size",title:"尺寸",align:"center",event:"size"},{field:"volume",title:"混凝土方量",align:"center"},{field:"weight",title:"构件重量",align:"center"},{field:"level",title:"混凝土等级",align:"center"},{field:"productDate",title:"生产日期",align:"center"},{field:"inboundDate",title:"入库日期",width:160,align:"center"},{field:"outboundDate",title:"出库日期",width:160,align:"center"},{field:"location",title:"区域",align:"center"},{field:"inboundCars",title:"入库车辆",align:"center"},{field:"outboundCars",title:"出库车辆",align:"center"}];break;case"inboundCars":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"company",title:"公司名称",align:"center"},{field:"inboundCars",title:"入库车辆",align:"center"},{field:"proName",title:"项目名称",align:"center"},{field:"buildingNum",title:"楼号",align:"center"},{field:"floorNum",title:"层号",align:"center"},{field:"category",title:"构件类别",align:"center"},{field:"componentName",title:"构件名称",align:"center"},{field:"size",title:"尺寸",align:"center"},{field:"volume",title:"混凝土方量",align:"center"},{field:"weight",title:"构件重量",align:"center"},{field:"level",title:"混凝土等级",align:"center"},{field:"productDate",title:"生产日期",align:"center"},{field:"inboundDate",title:"入库日期",width:160,align:"center"},{field:"location",title:"区域",align:"center"}];break;case"outboundCars":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"outboundCars",title:"出库车辆",align:"center"},{field:"proName",title:"项目名称",align:"center"},{field:"buildingNum",title:"楼号",align:"center"},{field:"floorNum",title:"层号",align:"center"},{field:"category",title:"构件类别",align:"center"},{field:"componentName",title:"构件名称",align:"center"},{field:"size",title:"尺寸",align:"center"},{field:"volume",title:"混凝土方量",align:"center"},{field:"weight",title:"构件重量",align:"center"},{field:"level",title:"混凝土等级",align:"center"},{field:"productDate",title:"生产日期",align:"center"},{field:"outboundDate",title:"出库日期",width:160,align:"center"},{field:"location",title:"区域",align:"center"}];break;case"admin":case"operator":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"phone",title:"用户名",align:"center"},{field:"password",title:"密码",align:"center",event:"password"},{field:"scope",title:"权限",align:"center",event:"scope",templet:"#scopeTpl"},{field:"date",title:"日期",width:160,align:"center"},{field:"operator",title:"操作人",align:"center"}];break;case"adminlog":case"inboundlog":case"outboundlog":case"accountlog":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"message",title:"详情",align:"left"},{field:"date",title:"日期",width:160,align:"center"}]}layui.use("table",function(){var t=layui.table;t.render({elem:"#demo",cellMinWidth:100,loading:!0,cols:[a],height:"full-200",id:"testReload2",data:e,even:!0,page:!0,limits:[50,100,200],limit:50,done:function(e,t,a){layui.$}});var n=layui.$,i={getCheckData:function(){var e=t.checkStatus("testReload2").data;console.log(e.length),console.log(e),e.forEach(function(e){downloadQRcode(e)})}};t.on("checkbox(quote)",function(e){e.checked&&n(".selectMore").show(),0==n("table input[type=checkbox]:checked").length&&n(".selectMore").hide()}),n(".selectMore").on("click",function(){var e=n(this).data("type");i[e]&&i[e].call(this)}),n("#demo .layui-btn.search_btn").on("click",function(){var e=n(this).data("type");i[e]&&i[e].call(this)}),t.on("tool(quote)",function(e){var t=e.data,a=e.event;"detail"===a?showModel(t):"del"===a?layer.confirm("真的删除行么",function(t){e.del(),layer.close(t)}):"edit"===a?layer.msg("编辑操作"):"download"===a&&(layer.msg("正在下载中..."),downloadQRcode(t));var i=n(".components dd.layui-this").attr("data-type");if(-1!=["inbound","admin","operator"].indexOf(i))switch(a){case"company":editValue("",e.event,"公司名",e);break;case"proName":editValue("",e.event,"项目名",e);break;case"buildingInfo":editValue("",e.event,"楼层号",e);break;case"buildingNum":editValue("",e.event,"楼号",e);break;case"floorNum":editValue("",e.event,"层号",e);break;case"category":editValue("",e.event,"构件类别",e);break;case"componentName":editValue("",e.event,"构件名称",e);break;case"size":editValue("",e.event,"尺寸",e);break;case"volume":editValue("",e.event,"混凝土方量",e);break;case"weight":editValue("",e.event,"构件重量",e);break;case"level":editValue("",e.event,"混凝土等级",e);break;case"productDate":editValue("",e.event,"生产日期",e);break;case"scope":editValue("",e.event,"账号权限",e);break;case"password":editValue("",e.event,"账号密码",e)}})})}function editValue(e,t,a,n){var i=getSession("scope"),o=n,l={};"scope"==n.event&&("1"==n.data[t]?n.data[t]="超级管理员":"2"==n.data[t]?n.data[t]="管理员":"3"==n.data[t]?n.data[t]="入库员":"4"==n.data[t]?n.data[t]="出库员":"5"==n.data[t]&&(n.data[t]="操作员")),layer.prompt({formType:2,title:"修改"+a,value:n.data[t]},function(e,a){if(layer.close(a),"2"!=i||"管理员"!=e){switch(n.event){case"company":if(-1==["永茂住工","远大住工","宝岳住工","君道住工"].indexOf(e))return void layer.confirm("公司名设置错误，请重新设置！",{btn:["确定"]});n.data[t]=e,o[t]=e,l[t]=e;break;case"buildingNum":if(-1==["1号楼","2号楼","3号楼","4号楼","5号楼","6号楼","7号楼","8号楼","9号楼","10号楼","11号楼","12号楼","13号楼","14号楼","15号楼","16号楼","17号楼","18号楼","19号楼","20号楼"].indexOf(e))return void layer.confirm("楼号设置错误，请重新设置！",{btn:["确定"]});n.data[t]=e,o[t]=e,l[t]=e;break;case"floorNum":if(-1==["1F","2F","3F","4F","5F","6F","7F","8F","9F","10F","11F","12F","13F","14F","15F","16F","17F","18F","19F","20F"].indexOf(e))return void layer.confirm("层号设置错误，请重新设置！",{btn:["确定"]});n.data[t]=e,o[t]=e,l[t]=e;break;case"category":if(-1==["墙","板","柱","梁","楼梯","阳台","凸窗"].indexOf(e))return void layer.confirm("构件类型设置错误，请重新设置！",{btn:["确定"]});n.data[t]=e,o[t]=e,l[t]=e;break;case"level":if(-1==["C30","C35","C40","C45","C50"].indexOf(e))return void layer.confirm("混凝土等级设置错误，请重新设置！",{btn:["确定"]});n.data[t]=e,o[t]=e,l[t]=e;break;case"scope":if(-1==["入库员","出库员","操作员","管理员"].indexOf(e))return void layer.confirm("权限设置错误，请重新设置！",{btn:["确定"]});"入库员"==e?(n.data[t]="3",l.type="operator",l[t]="3"):"出库员"==e?(n.data[t]="4",l.type="operator",l[t]="4"):"操作员"==e?(l.type="operator",n.data[t]="5",l[t]="5"):"管理员"==e&&(l.type="admin",n.data[t]="2",l[t]="2");break;default:n.data[t]=e,o[t]=e,l[t]=e}o.id=n.data.id,l.id=n.data.id,updataOrderData(o,l)}else layer.confirm("权限设置错误，请重新设置！",{btn:["确定"]})})}function updataOrderData(e,t){var a=e,n="http://www.zjgymzg.com/saveOrUpdateComponent",i=$(".components dd.layui-this").attr("data-type"),o=getSession("token");if("inbound"!=a.status)if("outbound"!=a.status){switch(i){case"inbound":n="http://www.zjgymzg.com/saveOrUpdateComponent";break;case"admin":case"operator":n="http://www.zjgymzg.com/saveOrUpdateCustomer"}"scope"==e.event&&(n="http://www.zjgymzg.com/setScope"),"password"==e.event&&(n="http://www.zjgymzg.com/saveOrUpdateCustomer",Object.assign(t,{token:o,type:i})),Object.assign(t,{token:o,status:"update"}),"scope"!=e.event&&"password"!=e.event||delete t.status,$.ajax({type:"post",url:n,contentType:"application/json",dataType:"json",data:JSON.stringify(t),beforeSend:function(){layer.msg("正在更新数据",{icon:16,time:3e6,shade:[.1,"#fff"]})},success:function(a){if(console.log(a),200!=a.status)return $("#msg").remove(),layer.msg(a.message),!1;layer.msg("更新成功！"),e.update(t)},error:function(e){layer.msg("网络异常，请稍后再试！")}})}else layer.confirm("该构件已出库，不可再修改！",{btn:["确定"]});else layer.confirm("该构件已入库，不可再修改！",{btn:["确定"]})}function showModel(e){$(".ms ul").empty(),$(".ms .contents .qcode img").removeAttr("src");var t='<li><label for="">公司名称:</label><span>'+e.company+'</span></li><li><label for="">项目名称:</label><span>'+e.proName+'</span></li><li><label for="">楼层号:</label><span>'+e.buildingNum+e.floorNum+'</span></li><li><label for="">构件名称:</label><span>'+e.category+'</span></li><li><label for="">构件名称:</label><span>'+e.componentName+'</span></li><li><label for="">尺寸:</label><span>'+e.size+'</span></li><li><label for="">混凝土方量:</label><span>'+e.volume+'</span></li><li><label for="">构件重量:</label><span>'+e.weight+'</span></li><li><label for="">混凝土等级:</label><span>'+e.level+'</span></li><li><label for="">生产日期:</label><span>'+e.productDate+'</span></li><li><label for="">入库车辆:</label><span>'+e.inboundCars+'</span></li><li><label for="">出库车辆:</label><span>'+e.outboundCars+'</span></li><li><label for="">区域:</label><span>'+e.location+'</span></li><li><label for="">入库日期:</label><span>'+e.inboundDate+'</span></li><li><label for="">出库日期:</label><span>'+e.outboundDate+'</span></li><li><label for="">构件状态:</label><span>'+e.status+"</span></li>";$(".ms ul").append(t),loaderQRcodeImg(e),layer.open({type:1,title:e.componentName,skin:"layui-layer-rim",area:["700px","640px"],content:$(".ms")})}function downloadQRcode(e){var t=e.proName+e.componentName;makeCode(e),downloadClick(productQrcodeImg(e),t)}function makeCode(e){var t={id:e.id,company:e.company,proName:e.proName,buildingNum:e.buildingNum,floorNum:e.floorNum,category:e.category,componentName:e.componentName,level:e.level,weight:e.weight,productDate:e.productDate},a=JSON.stringify(t);$("#qrcode").empty(),$("#qrcode").qrcode({width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:0,text:utf16to8(a)})}function utf16to8(e){var t,a,n,i;for(t="",n=e.length,a=0;a<n;a++)(i=e.charCodeAt(a))>=1&&i<=127?t+=e.charAt(a):i>2047?(t+=String.fromCharCode(224|i>>12&15),t+=String.fromCharCode(128|i>>6&63),t+=String.fromCharCode(128|i>>0&63)):(t+=String.fromCharCode(192|i>>6&31),t+=String.fromCharCode(128|i>>0&63));return t}function productQrcodeImg(e){e.id;var t=e.company,a=e.proName,n=e.buildingNum+e.floorNum,i=e.componentName,o=e.level,l=e.weight,d=e.productDate,r=document.createElement("canvas");r.width=720,r.height=520;var c=r.getContext("2d");c.fillStyle="#FFFFFF",c.fillRect(0,0,640,520);var s=$("#qrcode canvas")[0],u=document.createElement("canvas");return u.width=620,u.height=520,u.getContext("2d").font="40px Microsoft Yahei",u.getContext("2d").drawImage(r,0,0),u.getContext("2d").drawImage(s,60,250),u.getContext("2d").textAlign="left",u.getContext("2d").fillText(t,60,110),u.getContext("2d").fillText(a,60,170),u.getContext("2d").fillText(n,60,230),u.getContext("2d").textAlign="center",u.getContext("2d").font="70px Microsoft Yahei",u.getContext("2d").fillText(i,420,190),u.getContext("2d").font="30px Microsoft Yahei",u.getContext("2d").textAlign="left",u.getContext("2d").fillText("等级: "+o,305,280),u.getContext("2d").fillText("重量: "+l,305,340),u.getContext("2d").font="30px Microsoft Yahei",u.getContext("2d").fillText("生产日期: ",305,390),u.getContext("2d").font="30px Microsoft Yahei",u.getContext("2d").fillText(d,305,440),u.toDataURL("image/png")}function downloadClick(e,t){var a=$("<a>").attr("href",e).attr("download",t+".png");console.log(a),a[0].click()}function loaderQRcodeImg(e,t){e.proName,e.componentName;makeCode(e);var a=productQrcodeImg(e);$(".ms .contents .qcode img").attr("src",a)}$(function(){var e=getSession("scope");"1"==e?$("#accountName").text("超级管理员"):"2"==e&&($("#accountName").text("管理员"),$(".components dd[data-type=admin]").remove()),$(".addNewProduct").show();judgeIsLogin(),loadDataToType("add"),$(".components dd").click(function(e){var t=$(this).attr("data-type");$("#selectMoreTwoCode").hide(),$(".tab-header h2").html($(".components dd[data-type="+t+"]").find("a").text()),startTime=0,endTime=0,loadDataToType(t)}),layui.use(["form","layedit","laydate"],function(){var e=layui.form,t=layui.layer,a=(layui.layedit,layui.laydate);a.render({elem:"#beginDate",type:"datetime",calendar:!0,done:function(e,a,n){var i=timeToTimestamp(e);startTime=i,0!=endTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"开始时间不能超过结束时间！"})}}),a.render({elem:"#offDate",type:"datetime",done:function(e,a,n){var i=timeToTimestamp(e);endTime=i,0!=startTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"结束时间不能小于开始时间！"})}}),a.render({elem:"#outboundCarsBeginDate",type:"datetime",done:function(e,a,n){var i=timeToTimestamp(e);startTime=i,0!=endTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"开始时间不能超过结束时间！"})}}),a.render({elem:"#outboundCarsOffDate",type:"datetime",zIndex:99999999,done:function(e,a,n){var i=timeToTimestamp(e);endTime=i,0!=startTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"结束时间不能小于开始时间！"})}}),a.render({elem:"#inboundCarsBeginDate",type:"datetime",zIndex:99999999,done:function(e,a,n){var i=timeToTimestamp(e);startTime=i,0!=endTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"开始时间不能超过结束时间！"})}}),a.render({elem:"#inboundCarsOffDate",type:"datetime",zIndex:99999999,done:function(e,a,n){var i=timeToTimestamp(e);endTime=i,0!=startTime&&startTime>endTime&&t.open({zIndex:99999999,title:"提示",content:"结束时间不能小于开始时间！"})}}),e.on("select(search_type)",function(e){var t=$(".components dd.layui-this").attr("data-type");"all"==e.value&&($(".searchData").val(""),loadDataToType(t)),console.log(e.elem),console.log(e.value),console.log(e.othis)}),e.on("submit(search_btn)",function(e){var t=$(".components dd.layui-this").attr("data-type"),a=$(".searchData").val().trim(),n={};switch(startTime=0==startTime?void 0:startTime&&!isDate(String(startTime))?timestampToTime(startTime):$("#beginDate").val(),endTime=0==endTime?void 0:endTime&&!isDate(String(endTime))?timestampToTime(endTime):$("#offDate").val(),t){case"inbound":case"outbound":n[e.field.row]=a;break;case"inboundCars":startTime=$("#inboundCarsBeginDate").val(),endTime=$("#inboundCarsOffDate").val(),""!=(a=$(".searchData[name="+t+"]").val().trim())&&(n[e.field.row]=a),n.beginInboundDate=startTime,n.endInboundDate=endTime;break;case"outboundCars":startTime=$("#outboundCarsBeginDate").val(),endTime=$("#outboundCarsOffDate").val(),""!=(a=$(".searchData[name="+t+"]").val().trim())&&(n[e.field.row]=a),n.beginOutboundDate=startTime,n.endOutboundDate=endTime;break;case"adminlog":case"inboundlog":case"outboundlog":startTime=$("#beginDate").val(),endTime=$("#offDate").val(),""!=(a=$(".searchData[name=proName]").val().trim())&&(n.proName=a),n.beginDate=startTime,n.endDate=endTime}return loadDataToType(t,n),!1})}),$(".refresh_btn").click(function(){refreshData($(".components dd.layui-this").attr("data-type"))})});