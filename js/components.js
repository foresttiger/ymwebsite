var proName,buildingNum,floorNum,category,searchData={proName:void 0,buildingNum:void 0,floorNum:void 0,category:void 0,componentName:void 0};$(function(){searchData.proName=$("#scence dl[data-type=proName] dd.selected").attr("data-id");var a=getSession("scope");"1"==a?$("#accountName").text("\u8D85\u7EA7\u7BA1\u7406\u5458"):"2"==a&&($("#accountName").text("\u7BA1\u7406\u5458"),$(".components dd[data-type=admin]").remove()),$(".addNewProduct").show();var b;judgeIsLogin();var d=$(".components .layui-header a.linkThis").attr("data-type");"inbound"==d?(loadDataToType("add"),$(".tab-title h2").html("\u6784\u4EF6\u5206\u7C7B\u7BA1\u7406")):(loadDataToType("outbound"),$(".tab-title h2").html("\u6784\u4EF6\u51FA\u5E93\u7BA1\u7406")),layui.use("form",function(){var f=layui.form;f.on("select(search_type)",function(g){var h=$(".components .layui-header a.linkThis").attr("data-type");"all"==g.value&&($(".searchData").val(""),loadDataToType(h)),console.log(g.elem),console.log(g.value),console.log(g.othis)}),f.on("submit(search_btn)",function(g){var h=$(".components .layui-header a.linkThis").attr("data-type"),j=g.field.dataString;return b={type:g.field.row,value:j},loadDataToType(h,b),!1})}),$(".refresh_btn").click(function(){var f=$(".components .layui-header a.linkThis").attr("data-type");$(".searchData").val(""),refreshData(f)}),$("#scence dl dd").on("click",function(){var f=$(".searchData").val().trim(),g=$(this).parent().attr("data-type"),h=$("#scence dl[data-type="+g+"] dd.selected").attr("data-id"),j=$(this).attr("data-id");if(j!=h){"all"==j&&(j=""),$("#scence dl[data-type="+g+"] dd.selected").removeClass("selected"),$(this).addClass("selected"),console.log(j),searchData.componentName=f,"proName"===g?searchData.proName=j:"buildingNum"===g?searchData.buildingNum=j:"floorNum"===g?searchData.floorNum=j:"category"===g?searchData.category=j:void 0;var k=$(".components .headLine li a.linkThis").attr("data-type");loadDataToType(k,searchData)}})});function refreshData(a){var b=a;"inbound"==b&&(b="pc"),loadDataToType(b)}function loadDataToType(a,b,d){$("#selectData").empty();var f=0,g=getSession("token"),h=getSession("scope"),j="<option value=\"componentName\">\u6784\u4EF6\u540D\u79F0</option>";URL="http://www.zjgymzg.com/searchComponents";var m={token:g,status:d};switch(console.log(a),a){case"add":case"pc":case"update":case"inbound":m.status=void 0;break;case"inboundCars":m.status=void 0,!!b||(m.inboundCars="");break;case"outboundCars":case"outbound":!!b||(m.inboundCars=""),m.status="outbound";break;case"admin":delete m.status,m.type="admin";break;case"operator":delete m.status,m.type=a;break;default:m.type=a;}if("pc"===a||"add"===a||"update"===a||"inbound"===a?($(".select").show(),$(".addNewProduct").show(),$(".addAccount").hide(),$("#selectData").append(j)):"outbound"===a?($(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append(j)):"inboundCars"===a?($(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append("<option value=\"inboundCars\">\u5165\u5E93\u8F66\u8F86</option>")):"outboundCars"===a?($(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append("<option value=\"outboundCars\">\u51FA\u5E93\u8F66\u8F86</option>")):"admin"===a||"operator"===a?($(".select").hide(),$(".addAccount").show(),$(".addNewProduct").hide()):"adminlog"===a||"inboundlog"===a||"outboundlog"===a||"accountlog"===a?($(".select").hide(),$(".addNewProduct").hide(),$(".addAccount").hide()):void 0,layui.use("form",function(){var n=layui.form;n.render(),layer=layui.layer,f=layer.load(0,{shade:0.3})}),"add"===a||"update"===a||"outbound"===a||"inboundCars"===a||"outboundCars"===a?URL="http://www.zjgymzg.com/searchComponents":"admin"===a||"operator"===a?URL="http://www.zjgymzg.com/getCustomers":"adminlog"===a||"inboundlog"===a||"outboundlog"===a||"accountlog"===a?URL="http://www.zjgymzg.com/searchLog":void 0,b&&b.type)for(x in m[b.type]=b.value,searchData)searchData[x]&&(m[x]=searchData[x]);else for(x in b||(b=searchData),b)b[x]&&(m[x]=b[x]);$.ajax({url:URL,type:"post",contentType:"application/json",data:JSON.stringify(m)}).done(function(n){layer.close(f),renderOrderTable(n.list,a)}).fail(function(n){console.log(n),layer.msg("\u7F51\u7EDC\u5F02\u5E38\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\uFF01")})}function renderOrderTable(a,b){var d=[{title:"checkbox",type:"checkbox",width:80,fixed:"left"},{title:"\u5E8F\u53F7",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"\u4EA7\u54C1ID",width:80,sort:!0,align:"center",templet:"#idTpl"},{field:"company",title:"\u516C\u53F8\u540D",align:"center",event:"company",templet:"#companyTpl"},{field:"proName",title:"\u9879\u76EE\u540D\u79F0",align:"center",event:"proName",templet:"#proNameTpl"},{field:"buildingNum",title:"\u697C\u53F7",align:"center",event:"buildingNum",templet:"#buildingNumTpl"},{field:"floorNum",title:"\u5C42\u53F7",align:"center",event:"floorNum",templet:"#floorNumTpl"},{field:"category",title:"\u6784\u4EF6\u7C7B\u522B",align:"center",event:"category",templet:"#categoryTpl"},{field:"componentName",title:"\u6784\u4EF6\u540D\u79F0",align:"center",event:"componentName",templet:"#componentNameTpl"},{field:"size",title:"\u5C3A\u5BF8",align:"center",event:"size",templet:"#sizeTpl"},{field:"volume",title:"\u6DF7\u51DD\u571F\u65B9\u91CF",align:"center",event:"volume",templet:"#volumeTpl"},{field:"weight",title:"\u6784\u4EF6\u91CD\u91CF",align:"center",event:"weight",templet:"#weightTpl"},{field:"level",title:"\u6DF7\u51DD\u571F\u7B49\u7EA7",align:"center",event:"level",templet:"#levelTpl"},{field:"productDate",title:"\u751F\u4EA7\u65E5\u671F",align:"center",event:"productDate",templet:"productDateTpl"},{field:"inboundDate",title:"\u5165\u5E93\u65E5\u671F",width:160,align:"center",templet:"#inboundDateTpl"},{field:"outboundDate",title:"\u51FA\u5E93\u65E5\u671F",width:160,align:"center",templet:"#outboundDateTpl"},{field:"location",title:"\u533A\u57DF",align:"center",templet:"#locationTpl"},{field:"inboundCars",title:"\u5165\u5E93\u8F66\u8F86",align:"center",templet:"#inboundCarsTpl"},{field:"outboundCars",title:"\u51FA\u5E93\u8F66\u8F86",align:"center",templet:"#outboundCarsTpl"},{field:"right",title:"\u64CD\u4F5C",width:150,toolbar:"#components",align:"center",fixed:"right"}];"outbound"===b?d=[{title:"\u5E8F\u53F7",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"\u4EA7\u54C1ID",width:80,sort:!0,align:"center"},{field:"company",title:"\u516C\u53F8\u540D",align:"center"},{field:"proName",title:"\u9879\u76EE\u540D\u79F0",align:"center"},{field:"buildingInfo",title:"\u697C\u5C42\u53F7",align:"center"},{field:"buildingNum",title:"\u697C\u53F7",align:"center"},{field:"floorNum",title:"\u5C42\u53F7",align:"center"},{field:"category",title:"\u6784\u4EF6\u5206\u7C7B",align:"center"},{field:"componentName",title:"\u6784\u4EF6\u540D\u79F0",align:"center"},{field:"size",title:"\u5C3A\u5BF8",align:"center",event:"size"},{field:"volume",title:"\u6DF7\u51DD\u571F\u65B9\u91CF",align:"center"},{field:"weight",title:"\u6784\u4EF6\u91CD\u91CF",align:"center"},{field:"level",title:"\u6DF7\u51DD\u571F\u7B49\u7EA7",align:"center"},{field:"productDate",title:"\u751F\u4EA7\u65E5\u671F",align:"center"},{field:"inboundDate",title:"\u5165\u5E93\u65E5\u671F",width:160,align:"center"},{field:"outboundDate",title:"\u51FA\u5E93\u65E5\u671F",width:160,align:"center"},{field:"location",title:"\u533A\u57DF",align:"center"},{field:"inboundCars",title:"\u5165\u5E93\u8F66\u8F86",align:"center"},{field:"outboundCars",title:"\u51FA\u5E93\u8F66\u8F86",align:"center"},{field:"status",title:"\u72B6\u6001",align:"center"}]:void 0;layui.use("table",function(){var f=layui.table;f.render({elem:"#demo",cellMinWidth:100,loading:!0,cols:[d],height:"full-370",id:"testReload",data:a,even:!0,page:!0,limits:[10,20,50],limit:10,done:function(){var m=layui.$;m("[data-field='status']").css("display","none")}});var g=layui.$,h={getCheckData:function(){var j=f.checkStatus("testReload"),k=j.data;k.forEach(function(l){downloadQRcode(l)})},reload:function(){var j=g("#demoReload");f.reload("testReload",{where:{keyword:j.val()}})}};f.on("checkbox(quote)",function(j){j.checked&&g(".selectMore").show();var k=g("table input[type=checkbox]:checked").length;0==k&&g(".selectMore").hide()}),g("#demo .layui-btn.search_btn").on("click",function(){var j=g(this).data("type");h[j]?h[j].call(this):""}),g(".selectMore").on("click",function(){var j=g(this).data("type");h[j]?h[j].call(this):""}),f.on("tool(quote)",function(j){var k=j.data,l=j.event;"detail"===l?showModel(k):"del"===l?layer.confirm("\u771F\u7684\u5220\u9664\u884C\u4E48",function(n){j.del(),layer.close(n)}):"edit"===l?layer.msg("\u7F16\u8F91\u64CD\u4F5C"):"download"===l&&(layer.msg("\u6B63\u5728\u4E0B\u8F7D\u4E2D..."),downloadQRcode(k));var m=g(".components .headLine li a.linkThis").attr("data-type");-1!=["inbound","admin","operator"].indexOf(m)&&("company"===l?editValue("",j.event,"\u516C\u53F8\u540D",j):"proName"===l?editValue("",j.event,"\u9879\u76EE\u540D",j):"buildingInfo"===l?editValue("",j.event,"\u697C\u5C42\u53F7",j):"buildingNum"===l?editValue("",j.event,"\u697C\u53F7",j):"floorNum"===l?editValue("",j.event,"\u5C42\u53F7",j):"category"===l?editValue("",j.event,"\u6784\u4EF6\u7C7B\u522B",j):"componentName"===l?editValue("",j.event,"\u6784\u4EF6\u540D\u79F0",j):"size"===l?editValue("",j.event,"\u5C3A\u5BF8",j):"volume"===l?editValue("",j.event,"\u6DF7\u51DD\u571F\u65B9\u91CF",j):"weight"===l?editValue("",j.event,"\u6784\u4EF6\u91CD\u91CF",j):"level"===l?editValue("",j.event,"\u6DF7\u51DD\u571F\u7B49\u7EA7",j):"productDate"===l?editValue("",j.event,"\u751F\u4EA7\u65E5\u671F",j):"scope"===l?editValue("",j.event,"\u8D26\u53F7\u6743\u9650",j):"password"===l?editValue("",j.event,"\u8D26\u53F7\u5BC6\u7801",j):void 0)}),f.reload("testReload",{page:{curr:1}})})}function editValue(a,b,d,f){var g=getSession("scope"),h=f,j={};"1"==f.data[b]?f.data[b]="\u8D85\u7EA7\u7BA1\u7406\u5458":"2"==f.data[b]?f.data[b]="\u7BA1\u7406\u5458":"3"==f.data[b]?f.data[b]="\u5165\u5E93\u5458":"4"==f.data[b]?f.data[b]="\u51FA\u5E93\u5458":"5"==f.data[b]&&(f.data[b]="\u64CD\u4F5C\u5458"),layer.prompt({formType:2,title:"\u4FEE\u6539"+d,value:f.data[b]},function(k,l){if(layer.close(l),"2"==g&&"\u7BA1\u7406\u5458"==k)return void layer.confirm("\u6743\u9650\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});switch(f.event){case"company":if(-1==["\u6C38\u8302\u4F4F\u5DE5","\u8FDC\u5927\u4F4F\u5DE5","\u5B9D\u5CB3\u4F4F\u5DE5","\u541B\u5927\u4F4F\u5DE5"].indexOf(k))return void layer.confirm("\u516C\u53F8\u540D\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});f.data[b]=k,h[b]=k,j[b]=k;break;case"buildingNum":if(-1==["1\u53F7\u697C","2\u53F7\u697C","3\u53F7\u697C","4\u53F7\u697C","5\u53F7\u697C","6\u53F7\u697C","7\u53F7\u697C","8\u53F7\u697C","9\u53F7\u697C","10\u53F7\u697C","11\u53F7\u697C","12\u53F7\u697C","13\u53F7\u697C","14\u53F7\u697C","15\u53F7\u697C","16\u53F7\u697C","17\u53F7\u697C","18\u53F7\u697C","19\u53F7\u697C","20\u53F7\u697C"].indexOf(k))return void layer.confirm("\u697C\u53F7\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});f.data[b]=k,h[b]=k,j[b]=k;break;case"floorNum":if(-1==["1F","2F","3F","4F","5F","6F","7F","8F","9F","10F","11F","12F","13F","14F","15F","16F","17F","18F","19F","20F"].indexOf(k))return void layer.confirm("\u5C42\u53F7\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});f.data[b]=k,h[b]=k,j[b]=k;break;case"category":if(-1==["\u5899","\u677F","\u67F1","\u697C\u68AF","\u9633\u53F0","\u51F8\u7A97"].indexOf(k))return void layer.confirm("\u6784\u4EF6\u7C7B\u578B\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});f.data[b]=k,h[b]=k,j[b]=k;break;case"level":if(-1==["C30","C35","C40","C45"].indexOf(k))return void layer.confirm("\u6DF7\u51DD\u571F\u7B49\u7EA7\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});f.data[b]=k,h[b]=k,j[b]=k;break;case"scope":if(-1==["\u5165\u5E93\u5458","\u51FA\u5E93\u5458","\u64CD\u4F5C\u5458","\u7BA1\u7406\u5458"].indexOf(k))return void layer.confirm("\u6743\u9650\u8BBE\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u91CD\u65B0\u8BBE\u7F6E\uFF01",{btn:["\u786E\u5B9A"]});"\u5165\u5E93\u5458"==k?(f.data[b]="3",j.type="operator",j[b]="3"):"\u51FA\u5E93\u5458"==k?(f.data[b]="4",j.type="operator",j[b]="4"):"\u64CD\u4F5C\u5458"==k?(j.type="operator",f.data[b]="5",j[b]="5"):"\u7BA1\u7406\u5458"==k&&(j.type="admin",f.data[b]="2",j[b]="2");break;default:f.data[b]=k,h[b]=k,j[b]=k;}h.id=f.data.id,j.id=f.data.id,updataOrderData(h,j)})}function updataOrderData(a,b){var d=a,f="http://www.zjgymzg.com/saveOrUpdateComponent",g=$(".components .layui-header a.linkThis").attr("data-type"),h=getSession("token");if("inbound"==d.status)return void layer.confirm("\u8BE5\u6784\u4EF6\u5DF2\u5165\u5E93\uFF0C\u4E0D\u53EF\u518D\u4FEE\u6539\uFF01",{btn:["\u786E\u5B9A"]});if("outbound"==d.status)return void layer.confirm("\u8BE5\u6784\u4EF6\u5DF2\u51FA\u5E93\uFF0C\u4E0D\u53EF\u518D\u4FEE\u6539\uFF01",{btn:["\u786E\u5B9A"]});"inbound"===g?f="http://www.zjgymzg.com/saveOrUpdateComponent":"admin"===g||"operator"===g?f="http://www.zjgymzg.com/saveOrUpdateCustomer":void 0;"scope"==a.event&&(f="http://www.zjgymzg.com/setScope"),"password"==a.event&&(f="http://www.zjgymzg.com/saveOrUpdateCustomer",Object.assign(b,{token:h,type:g})),Object.assign(b,{token:h,status:"update"}),("scope"==a.event||"password"==a.event)&&delete b.status,$.ajax({type:"post",url:f,contentType:"application/json",dataType:"json",data:JSON.stringify(b),beforeSend:function(){layer.msg("\u6B63\u5728\u66F4\u65B0\u6570\u636E",{icon:16,time:3e6,shade:[0.1,"#fff"]})},success:function(j){return console.log(j),200==j.status?void(layer.msg("\u66F4\u65B0\u6210\u529F\uFF01"),a.update(b)):($("#msg").remove(),layer.msg(j.message),!1)},error:function(){layer.msg("\u7F51\u7EDC\u5F02\u5E38\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\uFF01")}})}function showModel(a){$(".ms ul").empty(),$(".ms .contents .qcode img").removeAttr("src");var b="<li><label for=\"\">\u516C\u53F8\u540D\u79F0:</label><span>"+a.company+"</span></li><li><label for=\"\">\u9879\u76EE\u540D\u79F0:</label><span>"+a.proName+"</span></li><li><label for=\"\">\u697C\u5C42\u53F7:</label><span>"+a.buildingNum+a.floorNum+"</span></li><li><label for=\"\">\u6784\u4EF6\u540D\u79F0:</label><span>"+a.category+"</span></li><li><label for=\"\">\u6784\u4EF6\u540D\u79F0:</label><span>"+a.componentName+"</span></li><li><label for=\"\">\u5C3A\u5BF8:</label><span>"+a.size+"</span></li><li><label for=\"\">\u6DF7\u51DD\u571F\u65B9\u91CF:</label><span>"+a.volume+"</span></li><li><label for=\"\">\u6784\u4EF6\u91CD\u91CF:</label><span>"+a.weight+"</span></li><li><label for=\"\">\u6DF7\u51DD\u571F\u7B49\u7EA7:</label><span>"+a.level+"</span></li><li><label for=\"\">\u751F\u4EA7\u65E5\u671F:</label><span>"+a.productDate+"</span></li><li><label for=\"\">\u5165\u5E93\u8F66\u8F86:</label><span>"+a.inboundCars+"</span></li><li><label for=\"\">\u51FA\u5E93\u8F66\u8F86:</label><span>"+a.outboundCars+"</span></li><li><label for=\"\">\u533A\u57DF:</label><span>"+a.location+"</span></li><li><label for=\"\">\u5165\u5E93\u65E5\u671F:</label><span>"+a.inboundDate+"</span></li><li><label for=\"\">\u51FA\u5E93\u65E5\u671F:</label><span>"+a.outboundDate+"</span></li><li><label for=\"\">\u6784\u4EF6\u72B6\u6001:</label><span>"+a.status+"</span></li>";$(".ms ul").append(b),loaderQRcodeImg(a),layer.open({type:1,title:a.componentName,skin:"layui-layer-rim",area:["700px","640px"],content:$(".ms")})}function downloadQRcode(a){var b=a.proName+a.componentName;makeCode(a);var d=productQrcodeImg(a);downloadClick(d,b)}function makeCode(a){var b={id:a.id,company:a.company,proName:a.proName,buildingNum:a.buildingNum,floorNum:a.floorNum,category:a.category,componentName:a.componentName,level:a.level,weight:a.weight,productDate:a.productDate},d=JSON.stringify(b);$("#qrcode").empty(),$("#qrcode").qrcode({width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:0,text:utf16to8(d)})}function utf16to8(a){var b,d,f,g;for(b="",f=a.length,d=0;d<f;d++)g=a.charCodeAt(d),1<=g&&127>=g?b+=a.charAt(d):2047<g?(b+=String.fromCharCode(224|15&g>>12),b+=String.fromCharCode(128|63&g>>6),b+=String.fromCharCode(128|63&g>>0)):(b+=String.fromCharCode(192|31&g>>6),b+=String.fromCharCode(128|63&g>>0));return b}function productQrcodeImg(a){var b=a.id,d=a.company,f=a.proName,g=a.buildingNum+a.floorNum,h=a.componentName,j=a.level,k=a.weight,l=a.productDate,m=document.createElement("canvas");m.width=720,m.height=520;var n=m.getContext("2d");n.fillStyle="#FFFFFF",n.fillRect(0,0,640,520);var o=$("#qrcode canvas")[0],p=document.createElement("canvas");return p.width=620,p.height=520,p.getContext("2d").font="40px Microsoft Yahei",p.getContext("2d").drawImage(m,0,0),p.getContext("2d").drawImage(o,55,250),p.getContext("2d").textAlign="left",p.getContext("2d").fillText(d||"\u6C38\u8302\u4F4F\u5DE5",55,110),p.getContext("2d").fillText("\u57CE\u5EFA\u6863\u6848\u9986",55,170),p.getContext("2d").fillText(g,55,230),p.getContext("2d").textAlign="center",p.getContext("2d").font="65px Microsoft Yahei",p.getContext("2d").fillText(h,420,190),p.getContext("2d").font="30px Microsoft Yahei",p.getContext("2d").textAlign="left",p.getContext("2d").fillText("\u7B49\u7EA7: C30",305,280),p.getContext("2d").fillText("\u91CD\u91CF: 50",305,340),p.getContext("2d").font="30px Microsoft Yahei",p.getContext("2d").fillText("\u751F\u4EA7\u65E5\u671F: ",305,390),p.getContext("2d").font="30px Microsoft Yahei",p.getContext("2d").fillText(l,305,440),p.toDataURL("image/png")}function downloadClick(a,b){var d=$("<a>"),f=d.attr("href",a).attr("download",b+".png");console.log(f),f[0].click()}function loaderQRcodeImg(a){a.proName+a.componentName;makeCode(a);var f=productQrcodeImg(a);$(".ms .contents .qcode img").attr("src",f)}