var proName=void 0,buildingNum=void 0,floorNum=void 0,category=void 0,searchData={proName:void 0,buildingNum:void 0,floorNum:void 0,category:void 0,componentName:void 0};function refreshData(e){var t=e;"inbound"==t&&(t="pc"),loadDataToType(t)}function loadDataToType(e,t,a){$("#selectData").empty();var o=0,n=getSession("token"),l=(getSession("scope"),'<option value="componentName">构件名称</option>');URL="http://www.zjgymzg.com/searchComponents";var i={token:n,status:a};switch(console.log(e),e){case"add":case"pc":case"update":case"inbound":i.status=void 0;break;case"inboundCars":i.status=void 0,t||(i.inboundCars="");break;case"outboundCars":case"outbound":t||(i.inboundCars=""),i.status="outbound";break;case"admin":delete i.status,i.type="admin";break;case"operator":delete i.status,i.type=e;break;default:i.type=e}switch(e){case"pc":case"add":case"update":case"inbound":$(".select").show(),$(".addNewProduct").show(),$(".addAccount").hide(),$("#selectData").append(l);break;case"outbound":$(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append(l);break;case"inboundCars":$(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append('<option value="inboundCars">入库车辆</option>');break;case"outboundCars":$(".select").show(),$(".addNewProduct").hide(),$(".addAccount").hide(),$("#selectData").append('<option value="outboundCars">出库车辆</option>');break;case"admin":case"operator":$(".select").hide(),$(".addAccount").show(),$(".addNewProduct").hide();break;case"adminlog":case"inboundlog":case"outboundlog":case"accountlog":$(".select").hide(),$(".addNewProduct").hide(),$(".addAccount").hide()}var d=void 0;switch(layui.use("form",function(){layui.form.render(),d=layui.layer,o=d.load(0,{shade:.3})}),e){case"add":case"update":case"outbound":case"inboundCars":case"outboundCars":URL="http://www.zjgymzg.com/searchComponents";break;case"admin":case"operator":URL="http://www.zjgymzg.com/getCustomers";break;case"adminlog":case"inboundlog":case"outboundlog":case"accountlog":URL="http://www.zjgymzg.com/searchLog"}if(t&&t.type)for(x in i[t.type]=t.value,searchData)searchData[x]&&(i[x]=searchData[x]);else for(x in t||(t=searchData),t)t[x]&&(i[x]=t[x]);$.ajax({url:URL,type:"post",contentType:"application/json",data:JSON.stringify(i)}).done(function(t){d.close(o),renderOrderTable(t.list,e)}).fail(function(e){console.log(e),d.msg("网络异常，请稍后再试！")})}function renderOrderTable(e,t){var a=[{title:"checkbox",type:"checkbox",width:80,fixed:"left"},{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"产品ID",width:80,sort:!0,align:"center",templet:"#idTpl"},{field:"company",title:"公司名",align:"center",event:"company",templet:"#companyTpl"},{field:"proName",title:"项目名称",align:"center",event:"proName",templet:"#proNameTpl"},{field:"buildingNum",title:"楼号",align:"center",event:"buildingNum",templet:"#buildingNumTpl"},{field:"floorNum",title:"层号",align:"center",event:"floorNum",templet:"#floorNumTpl"},{field:"category",title:"构件类别",align:"center",event:"category",templet:"#categoryTpl"},{field:"componentName",title:"构件名称",align:"center",event:"componentName",sort:!0,templet:"#componentNameTpl"},{field:"size",title:"尺寸",align:"center",event:"size",templet:"#sizeTpl"},{field:"volume",title:"混凝土方量",align:"center",sort:!0,event:"volume",templet:"#volumeTpl"},{field:"weight",title:"构件重量",align:"center",event:"weight",templet:"#weightTpl"},{field:"level",title:"混凝土等级",align:"center",event:"level",templet:"#levelTpl"},{field:"productDate",title:"生产日期",align:"center",event:"productDate",templet:"productDateTpl"},{field:"inboundDate",title:"入库日期",width:160,align:"center",templet:"#inboundDateTpl"},{field:"outboundDate",title:"出库日期",width:160,align:"center",templet:"#outboundDateTpl"},{field:"location",title:"区域",align:"center",templet:"#locationTpl"},{field:"inboundCars",title:"入库车辆",align:"center",templet:"#inboundCarsTpl"},{field:"outboundCars",title:"出库车辆",align:"center",templet:"#outboundCarsTpl"},{field:"right",title:"操作",width:150,toolbar:"#components",align:"center",fixed:"right"}];switch(t){case"outbound":a=[{title:"序号",templet:"#indexTpl",width:80,fixed:"left",align:"center"},{field:"id",title:"产品ID",width:80,sort:!0,align:"center"},{field:"company",title:"公司名",align:"center"},{field:"proName",title:"项目名称",align:"center"},{field:"buildingInfo",title:"楼层号",align:"center"},{field:"buildingNum",title:"楼号",align:"center"},{field:"floorNum",title:"层号",align:"center"},{field:"category",title:"构件分类",align:"center"},{field:"componentName",title:"构件名称",align:"center"},{field:"size",title:"尺寸",align:"center",event:"size"},{field:"volume",title:"混凝土方量",align:"center"},{field:"weight",title:"构件重量",align:"center"},{field:"level",title:"混凝土等级",align:"center"},{field:"productDate",title:"生产日期",align:"center"},{field:"inboundDate",title:"入库日期",width:160,align:"center"},{field:"outboundDate",title:"出库日期",width:160,align:"center"},{field:"location",title:"区域",align:"center"},{field:"inboundCars",title:"入库车辆",align:"center"},{field:"outboundCars",title:"出库车辆",align:"center"},{field:"status",title:"状态",align:"center"}]}layui.use("table",function(){var t=layui.table;t.render({elem:"#demo",cellMinWidth:100,loading:!0,cols:[a],height:"full-370",id:"testReload",data:e,even:!0,page:!0,limits:[10,20,50],limit:10,done:function(e,t,a){(0,layui.$)("[data-field='status']").css("display","none")}});var o=layui.$,n={getCheckData:function(){t.checkStatus("testReload").data.forEach(function(e){downloadQRcode(e)})},reload:function(){var e=o("#demoReload");t.reload("testReload",{where:{keyword:e.val()}})}};t.on("checkbox(quote)",function(e){e.checked&&o(".selectMore").show(),0==o("table input[type=checkbox]:checked").length&&o(".selectMore").hide()}),o("#demo .layui-btn.search_btn").on("click",function(){var e=o(this).data("type");n[e]&&n[e].call(this)}),o(".selectMore").on("click",function(){var e=o(this).data("type");n[e]&&n[e].call(this)}),t.on("tool(quote)",function(e){var t=e.data,a=e.event;"detail"===a?showModel(t):"del"===a?layer.confirm("真的删除行么",function(t){e.del(),layer.close(t)}):"edit"===a?layer.msg("编辑操作"):"download"===a&&(layer.msg("正在下载中..."),downloadQRcode(t));var n=o(".components .headLine li a.linkThis").attr("data-type");if(-1!=["inbound","admin","operator"].indexOf(n))switch(a){case"company":editValue("",e.event,"公司名",e);break;case"proName":editValue("",e.event,"项目名",e);break;case"buildingInfo":editValue("",e.event,"楼层号",e);break;case"buildingNum":editValue("",e.event,"楼号",e);break;case"floorNum":editValue("",e.event,"层号",e);break;case"category":editValue("",e.event,"构件类别",e);break;case"componentName":editValue("",e.event,"构件名称",e);break;case"size":editValue("",e.event,"尺寸",e);break;case"volume":editValue("",e.event,"混凝土方量",e);break;case"weight":editValue("",e.event,"构件重量",e);break;case"level":editValue("",e.event,"混凝土等级",e);break;case"productDate":editValue("",e.event,"生产日期",e);break;case"scope":editValue("",e.event,"账号权限",e);break;case"password":editValue("",e.event,"账号密码",e)}}),t.reload("testReload",{page:{curr:1}})})}function editValue(e,t,a,o){var n=getSession("scope"),l=o,i={};"1"==o.data[t]?o.data[t]="超级管理员":"2"==o.data[t]?o.data[t]="管理员":"3"==o.data[t]?o.data[t]="入库员":"4"==o.data[t]?o.data[t]="出库员":"5"==o.data[t]&&(o.data[t]="操作员"),layer.prompt({formType:2,title:"修改"+a,value:o.data[t]},function(e,a){if(layer.close(a),"2"!=n||"管理员"!=e){switch(o.event){case"company":if(-1==["永茂住工","远大住工","宝岳住工","君道住工"].indexOf(e))return void layer.confirm("公司名设置错误，请重新设置！",{btn:["确定"]});o.data[t]=e,l[t]=e,i[t]=e;break;case"buildingNum":if(-1==["1号楼","2号楼","3号楼","4号楼","5号楼","6号楼","7号楼","8号楼","9号楼","10号楼","11号楼","12号楼","13号楼","14号楼","15号楼","16号楼","17号楼","18号楼","19号楼","20号楼"].indexOf(e))return void layer.confirm("楼号设置错误，请重新设置！",{btn:["确定"]});o.data[t]=e,l[t]=e,i[t]=e;break;case"floorNum":if(-1==["1F","2F","3F","4F","5F","6F","7F","8F","9F","10F","11F","12F","13F","14F","15F","16F","17F","18F","19F","20F"].indexOf(e))return void layer.confirm("层号设置错误，请重新设置！",{btn:["确定"]});o.data[t]=e,l[t]=e,i[t]=e;break;case"category":if(-1==["墙","板","柱","梁","楼梯","阳台","凸窗"].indexOf(e))return void layer.confirm("构件类型设置错误，请重新设置！",{btn:["确定"]});o.data[t]=e,l[t]=e,i[t]=e;break;case"level":if(-1==["C30","C35","C40","C45","C50"].indexOf(e))return void layer.confirm("混凝土等级设置错误，请重新设置！",{btn:["确定"]});o.data[t]=e,l[t]=e,i[t]=e;break;case"scope":if(-1==["入库员","出库员","操作员","管理员"].indexOf(e))return void layer.confirm("权限设置错误，请重新设置！",{btn:["确定"]});"入库员"==e?(o.data[t]="3",i.type="operator",i[t]="3"):"出库员"==e?(o.data[t]="4",i.type="operator",i[t]="4"):"操作员"==e?(i.type="operator",o.data[t]="5",i[t]="5"):"管理员"==e&&(i.type="admin",o.data[t]="2",i[t]="2");break;default:o.data[t]=e,l[t]=e,i[t]=e}l.id=o.data.id,i.id=o.data.id,updataOrderData(l,i)}else layer.confirm("权限设置错误，请重新设置！",{btn:["确定"]})})}function updataOrderData(e,t){var a=e,o="http://www.zjgymzg.com/saveOrUpdateComponent",n=$(".components .layui-header a.linkThis").attr("data-type"),l=getSession("token");if("inbound"!=a.status)if("outbound"!=a.status){switch(n){case"inbound":o="http://www.zjgymzg.com/saveOrUpdateComponent";break;case"admin":case"operator":o="http://www.zjgymzg.com/saveOrUpdateCustomer"}"scope"==e.event&&(o="http://www.zjgymzg.com/setScope"),"password"==e.event&&(o="http://www.zjgymzg.com/saveOrUpdateCustomer",Object.assign(t,{token:l,type:n})),Object.assign(t,{token:l,status:"update"}),"scope"!=e.event&&"password"!=e.event||delete t.status,$.ajax({type:"post",url:o,contentType:"application/json",dataType:"json",data:JSON.stringify(t),beforeSend:function(){layer.msg("正在更新数据",{icon:16,time:3e6,shade:[.1,"#fff"]})},success:function(a){if(console.log(a),200!=a.status)return $("#msg").remove(),layer.msg(a.message),!1;layer.msg("更新成功！"),e.update(t)},error:function(e){layer.msg("网络异常，请稍后再试！")}})}else layer.confirm("该构件已出库，不可再修改！",{btn:["确定"]});else layer.confirm("该构件已入库，不可再修改！",{btn:["确定"]})}function showModel(e){$(".ms ul").empty(),$(".ms .contents .qcode img").removeAttr("src");var t='<li><label for="">公司名称:</label><span>'+e.company+'</span></li><li><label for="">项目名称:</label><span>'+e.proName+'</span></li><li><label for="">楼层号:</label><span>'+e.buildingNum+e.floorNum+'</span></li><li><label for="">构件名称:</label><span>'+e.category+'</span></li><li><label for="">构件名称:</label><span>'+e.componentName+'</span></li><li><label for="">尺寸:</label><span>'+e.size+'</span></li><li><label for="">混凝土方量:</label><span>'+e.volume+'</span></li><li><label for="">构件重量:</label><span>'+e.weight+'</span></li><li><label for="">混凝土等级:</label><span>'+e.level+'</span></li><li><label for="">生产日期:</label><span>'+e.productDate+'</span></li><li><label for="">入库车辆:</label><span>'+e.inboundCars+'</span></li><li><label for="">出库车辆:</label><span>'+e.outboundCars+'</span></li><li><label for="">区域:</label><span>'+e.location+'</span></li><li><label for="">入库日期:</label><span>'+e.inboundDate+'</span></li><li><label for="">出库日期:</label><span>'+e.outboundDate+'</span></li><li><label for="">构件状态:</label><span>'+e.status+"</span></li>";$(".ms ul").append(t),loaderQRcodeImg(e),layer.open({type:1,title:e.componentName,skin:"layui-layer-rim",area:["700px","640px"],content:$(".ms")})}function downloadQRcode(e){var t=e.proName+e.componentName;makeCode(e),downloadClick(productQrcodeImg(e),t)}function makeCode(e){var t={id:e.id,company:e.company,proName:e.proName,buildingNum:e.buildingNum,floorNum:e.floorNum,category:e.category,componentName:e.componentName,level:e.level,weight:e.weight,productDate:e.productDate},a=JSON.stringify(t);$("#qrcode").empty(),$("#qrcode").qrcode({width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:0,text:utf16to8(a)})}function utf16to8(e){var t,a,o,n;for(t="",o=e.length,a=0;a<o;a++)(n=e.charCodeAt(a))>=1&&n<=127?t+=e.charAt(a):n>2047?(t+=String.fromCharCode(224|n>>12&15),t+=String.fromCharCode(128|n>>6&63),t+=String.fromCharCode(128|n>>0&63)):(t+=String.fromCharCode(192|n>>6&31),t+=String.fromCharCode(128|n>>0&63));return t}function productQrcodeImg(e){e.id;var t=e.company,a=(e.proName,e.buildingNum+e.floorNum),o=e.componentName,n=(e.level,e.weight,e.productDate),l=document.createElement("canvas");l.width=720,l.height=520;var i=l.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,640,520);var d=$("#qrcode canvas")[0],r=document.createElement("canvas");return r.width=620,r.height=520,r.getContext("2d").font="40px Microsoft Yahei",r.getContext("2d").drawImage(l,0,0),r.getContext("2d").drawImage(d,55,250),r.getContext("2d").textAlign="left",r.getContext("2d").fillText(t||"永茂住工",55,110),r.getContext("2d").fillText("城建档案馆",55,170),r.getContext("2d").fillText(a,55,230),r.getContext("2d").textAlign="center",r.getContext("2d").font="65px Microsoft Yahei",r.getContext("2d").fillText(o,420,190),r.getContext("2d").font="30px Microsoft Yahei",r.getContext("2d").textAlign="left",r.getContext("2d").fillText("等级: C30",305,280),r.getContext("2d").fillText("重量: 50",305,340),r.getContext("2d").font="30px Microsoft Yahei",r.getContext("2d").fillText("生产日期: ",305,390),r.getContext("2d").font="30px Microsoft Yahei",r.getContext("2d").fillText(n,305,440),r.toDataURL("image/png")}function downloadClick(e,t){var a=$("<a>").attr("href",e).attr("download",t+".png");console.log(a),a[0].click()}function loaderQRcodeImg(e,t){e.proName,e.componentName;makeCode(e);var a=productQrcodeImg(e);$(".ms .contents .qcode img").attr("src",a)}$(function(){searchData.proName=$("#scence dl[data-type=proName] dd.selected").attr("data-id");var e=getSession("scope");"1"==e?$("#accountName").text("超级管理员"):"2"==e&&($("#accountName").text("管理员"),$(".components dd[data-type=admin]").remove()),$(".addNewProduct").show();judgeIsLogin(),"inbound"==$(".components .layui-header a.linkThis").attr("data-type")?(loadDataToType("add"),$(".tab-title h2").html("构件分类管理")):(loadDataToType("outbound"),$(".tab-title h2").html("构件出库管理")),layui.use("form",function(){var e=layui.form;e.on("select(search_type)",function(e){var t=$(".components .layui-header a.linkThis").attr("data-type");"all"==e.value&&($(".searchData").val(""),loadDataToType(t)),console.log(e.elem),console.log(e.value),console.log(e.othis)}),e.on("submit(search_btn)",function(e){var t={},a=$(".components .layui-header a.linkThis").attr("data-type"),o=e.field.dataString;return t[e.field.row]=o,loadDataToType(a,t),!1})}),$(".refresh_btn").click(function(){var e=$(".components .layui-header a.linkThis").attr("data-type");$(".searchData").val(""),refreshData(e)}),$("#scence dl dd").on("click",function(){var e=$(".searchData").val().trim(),t=$(this).parent().attr("data-type"),a=$("#scence dl[data-type="+t+"] dd.selected").attr("data-id"),o=$(this).attr("data-id");if(o!=a){switch("all"==o&&(o=""),$("#scence dl[data-type="+t+"] dd.selected").removeClass("selected"),$(this).addClass("selected"),console.log(o),searchData.componentName=e,t){case"proName":searchData.proName=o;break;case"buildingNum":searchData.buildingNum=o;break;case"floorNum":searchData.floorNum=o;break;case"category":searchData.category=o}loadDataToType($(".components .headLine li a.linkThis").attr("data-type"),searchData)}})});